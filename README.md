# Lottery Factory

- В контракте создаются игры/лотереи каждые N часов. 
- Игрок может купить токены за эфир. Стоимость токенов растет каждые N минут по заранее известной шкале.
- Токены можно продать другим игрокам по текущей цене. То есть в любой момент можно выставить купленные токены на продажу. При этом если кто-то хочет их купить, то он сначала выкупает их у других игроков, а только потом у системы (если предложений от игроков нет)
- По окончанию N часов определяется победитель(с наибольшим кол-вом токенов), который получает весь оставшийся банк эфира

## Public methods

##### approveToSell(uint _tokenCount)
Выставить _tokenCount токенов на продажу. 

##### balanceOf(address _user)
Возвращает баланс игрока в токенах.

##### balanceSellingOf(address _user)
Возвращает кол-во токенов, выставленных в данный момент на продажу.

##### buyTokens()
Покупает токены. Если текущая цена за 1 токен = 0.1 eth, то отправив 0.3 eth, игрок купит 3 токена. Сначала выкупаются токены, которые висят на продаже, затем токены у системы. Если на продаже висит 10 токенов, а игрок хочет купить 15, то 10 токенов приобретутся у продавцов, а 5 будут докуплены у системы.

##### disapproveToSell(uint _tokenCount)
Снять _tokenCount токенов с продажи.

##### getLotteryAtIndex(uint _index)
Возвращает информацию о лотерее по ее индексу. Вернет массив с параметрами(по порядку): 
- timestamp создания
- общее кол-во выпущенных токенов
- общее кол-во токенов на продаже
- джекпот/выигрыш победителя
- победитель
- забрал ли победитель приз
- массив со всеми адресами участников
- длительность лотереи в секундах
- начальная цена токена
- длительность раунда повышения цены в секундах
- на сколько % повышается цена за 1 токен в каждом раунде
- комиссия контракта при трейдинге токенов
- комиссия контракта при выплате выигрыша победителю

##### getTop(uint _n)
Возвращает топ _n пользователей по числу токенов. Метод возвращает 2 массива: адреса и балансы, отсортированные по убыванию.

##### isTokenSelling(uint _tokenId)
Выставлен ли токен с id/индексом _tokenId на продажу. 

##### ownerOf(uint _tokenId)
Возвращает адрес владельца токена с id _tokenId.

##### tokensOf(address _user)
Возвращает массив с id токенов, которые принадлежат _user.

##### tokensToSellOnce()
Возвращает массив токенов, которые однажды были выставлены на продажу. В этом массиве могут дублироваться id токенов, поэтому нужно проверять через isTokenSelling() действительно ли токен в данный момент продается. Этот метод вряд ли пригодится на клиенте, но нужен для тестов.

##### function updateParams( uint _gameDuration, uint _initialTokenPrice, uint _durationToTokenPriceUp, uint _tokenPriceIncreasePercent, uint _tradeCommission, uint _winnerCommission )
Обновление параметров лотереи. Параметры будут применены при создании следующей лотереи.
_gameDuration - длина 1 игры в секундах
_initialTokenPrice - начальная цена за 1 токен в wei
_durationToTokenPriceUp - время в секундах, после которого цена за 1 токен повышается
_tokenPriceIncreasePercent - на сколько % повышается цена за 1 токен на каждом шаге
_tradeCommission - комиссия системы в % при покупке игроком токена у другого игрока
_winnerCommission - комиссия системы в % при переводе выигрыша игрока

##### withdraw()
Перевод суммы всех комиссий на адрес создателя контракта.

##### withdrawForWinner(uint _lotteryIndex)
Метод может вызвать только победитель лотереи с индексом _lotteryIndex. Переводит выигрыш победителю.

## Как загрузить в реальную или тестовую сеть
1. установить и зайти в [metamask](https://metamask.io/)
2. в metamask выбрать тестовую(ropsten, kovan, rinkeby) или main сеть
3. исходник из файла LotteryFactory.sol скопировать в [remix](https://remix.ethereum.org/)
4. на вкладке "compile" нажать "Start to compile"
5. на вкладке "run" в "environment" выбрать "Injected Web3" и выбрать номер счета из "account"
6. нажать на "Deploy", появится окно MetaMask где нужно будет подтвердить транзакцию

## Особенности
- при равенстве кол-ва токенов победителем признается тот, кто раньше их купил. То есть если user1 купил 10 токенов, а через час user2 купил столько же, то победителем будет user1.
- цена за 1 токен увеличивается за каждый шаг на одну и ту же сумму. То есть если начальная цена за 1 токен 1 eth и прирост за шаг 10%, то каждые 15 мин цена токена будет увеличиваться на 0.1 eth.
- насчет автоматического создания игр. В ethereum нет такого, чтобы установить таймер и следить за наступлением определенного события. В нашем случае нужно по истечению 6 часов создавать новую игру. Аукционы создаются в момент покупки токенов. То есть если аукцион начался в 0:00 и закончился в 06:00, а сейчас 07:00 и user1 покупает 1 токен, то только в этот момент аукцион будет создан, хотя время начала у него будет 06:00:01. В интерфейсе придется высчитывать в каком временном промежутке сейчас идет игра. То есть на фронтенде нужно будет получить время начала последней игры и рассчитать текущий временной интервал.